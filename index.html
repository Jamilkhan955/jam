<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="lib/jam.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/jam.js</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><p>lib/jam.js - Main JAM entrypoint</p></div></div><div class="code"><div class="wrapper"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">),</span> <span class="nx">tick</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find out if we have setImmediate and fallback to setTimeout if necessary.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">tick</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">setImmediate</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
    <span class="nx">setImmediate</span> <span class="o">:</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="internal-helpers">INTERNAL HELPERS</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Function and arguments helpers.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">toArgs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span> <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">replaceHead</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">newHead</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArgs</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span><span class="nx">newHead</span><span class="p">];</span>

    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newHead</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">args</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Common assertions</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">argName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">func</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="nx">argName</span> <span class="o">+</span> <span class="s1">&#39; argument missing or not a function&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">ensureNum</span><span class="p">(</span><span class="nx">num</span><span class="p">,</span> <span class="nx">argName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">num</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="nx">argName</span> <span class="o">+</span> <span class="s1">&#39; argument missing or not a number&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">ensureArray</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">argName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">(</span><span class="nx">arr</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">arr</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
      <span class="nx">argName</span> <span class="o">+</span> <span class="s1">&#39; argument missing or does not looks like an array&#39;</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="helpers">HELPERS</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Additional functions that adds to the original jam function.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">includeHelpers</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jamidentity">jam.identity()</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Simple function that passes the values it receives to the next function.
Useful if you need a <code>process.nextTick</code> inserted in-between your call chain.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">identity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">_identity</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
        <span class="nx">tick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">next</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">replaceHead</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="kc">null</span><span class="p">));</span>
        <span class="p">});</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This function can also be passed to jam verbatim.</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">next</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">?</span>
        <span class="nx">_identity</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">:</span>
        <span class="nx">_identity</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jamnexttick">jam.nextTick()</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alias for <code>.identity</code>. Use when you need a <code>process.nextTick</code> inserted in-between
your call chain.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">identity</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jamreturn-args-">jam.return( [args...] )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Returns a set of values to the next function in the chain. Useful when you want to
pass in the next function verbatim without wrapping it in a <code>function() { }</code> just
to pass values into it.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="k">return</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArgs</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jamnull">jam.null()</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Similar to <code>.identity</code> but absorbs all arguments that has been passed to it and
forward nothing to the next function. Effectively nullifying any arguments passed
from previous jam call.</p>

<p>Like <code>jam.identity</code>, this function can be passed to the jam chain verbatim.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="kc">null</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">_null</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span> <span class="nx">next</span><span class="p">();</span> <span class="p">}</span>

      <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">next</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">_null</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">:</span> <span class="nx">_null</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jamcall-function-args-">jam.call( function, [args...] )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convenience for calling functions that accepts arguments in standard node.js
convention. Since jam insert <code>next</code> as first argument, most functions cannot be
passed directly into the jam chain, thus this helper function.</p>

<p>If no <code>args</code> is given, this function passes arguments given to <code>next()</code> call from
previous function directly to the function (with proper callback) placement).</p>

<p>Use this in combination with <code>jam.return</code> or <code>jam.null</code> if you want to control the
arguments that are passed to the function.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArgs</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">// func</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// use provided arguments</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
          <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">};</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// use passed-in arguments during chain resolution</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">args</span> <span class="o">=</span> <span class="nx">toArgs</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">// move next to last position</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>

          <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jameach-array-iterator-next-element-index--">jam.each( array, iterator( next, element, index ) )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Execute the given <code>iterator</code> function for each element given in the <code>array</code>. The
iterator is given a <code>next</code> function and the element to act on. The next step in the
chain will receive the original array passed verbatim so you can chain multiple
<code>.each</code> calls to act on the same array.</p>

<p>You can also pass <code>arguments</code> and <code>"strings"</code> as an array or you can omit the array
entirely, in which case this method will assume that the previous chain step
returns something that looks like an array as its first result.</p>

<p>Under the hood, a JAM step is added for each element. So the iterator will be
called serially, one after another finish. A parallel version maybe added in the
future.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">array</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">array</span><span class="p">;</span>
        <span class="nx">array</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">ensureArray</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="s1">&#39;iterator&#39;</span><span class="p">);</span>

      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">array_</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">array</span> <span class="o">||</span> <span class="nx">array_</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Builds another JAM chain internally</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">chain</span> <span class="o">=</span> <span class="nx">jam</span><span class="p">(</span><span class="nx">jam</span><span class="p">.</span><span class="nx">identity</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">chain</span> <span class="o">=</span> <span class="nx">chain</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span> <span class="nx">iterator</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span> <span class="p">});</span>
        <span class="p">})(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">);</span>

        <span class="nx">chain</span> <span class="o">=</span> <span class="nx">chain</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span> <span class="p">});</span>
        <span class="k">return</span> <span class="nx">chain</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jammap-array-iterator-next-element-index--">jam.map( array, iterator( next, element, index ) )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Works exactly like the <code>each</code> helper but if a value is passed to the iterator's
<code>next</code> function, it is collected into a new array which will be passed to the next
function in the JAM chain after <code>map</code>.</p>

<p>Like with <code>each</code>, you can omit the <code>array</code> input, in which case this method will
assume that the previous chain step returns something that looks like an array as
its first result.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">array</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">array</span><span class="p">;</span>
        <span class="nx">array</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">ensureArray</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="s1">&#39;iterator&#39;</span><span class="p">);</span>

      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">array_</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">array</span> <span class="o">||</span> <span class="nx">array_</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Builds another JAM chain internally and collect results.
TODO: Dry with .each?</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">chain</span> <span class="o">=</span> <span class="nx">jam</span><span class="p">(</span><span class="nx">jam</span><span class="p">.</span><span class="nx">identity</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
          <span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">chain</span> <span class="o">=</span> <span class="nx">chain</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">previous</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">previous</span><span class="p">);</span>
            <span class="nx">iterator</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">})(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">);</span>

        <span class="nx">chain</span> <span class="o">=</span> <span class="nx">chain</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">last</span><span class="p">);</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">// discard first undefined element</span>
          <span class="nx">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">chain</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jamtimeout-timeout-">jam.timeout( timeout )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pauses the chain for the specified <code>timeout</code> using <code>setTimeout</code>. Useful for
inserting a delay in-between a long jam chain.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ensureNum</span><span class="p">(</span><span class="nx">timeout</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">);</span>

      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">replaceHead</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">next</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span> <span class="p">},</span> <span class="nx">timeout</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="jampromise-chain-">jam.promise( [chain] )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Returns a JAM promise, useful when you are starting an asynchronous call outside of
the JAM chain itself but wants the callback to call into the chain. In other words,
this allow you to put a 'waiting point' (aka promise?) into existing JAM chain that
waits for the initial call to finish and also pass any arguments passed to the
callback to the next step in the JAM chain as well.</p>

<p>This function will returns a callback that automatically bridges into the JAM
chain. You can pass the returned callback to any asynchronous function and the JAM
chain (at the point of calling .promise()) will wait for that asynchronous function
to finish effectively creating a 'waiting point'.</p>

<p>Additionally, any arguments passed to the callback are forwarded to the next call
in the JAM chain as well. If errors are passed, then it is fast-forwarded to the
last handler normally like normal JAM steps.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">func</span><span class="p">.</span><span class="nx">promise</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">chain</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">chain</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="nx">chain</span> <span class="o">:</span> <span class="c1">// chain is supplied</span>
        <span class="k">typeof</span> <span class="k">this</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="c1">// called from the chain variable</span>
        <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">chain</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">);</span> <span class="c1">// fails</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">chain</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="k">this</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">chain</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">next</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

      <span class="nx">chain</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">next_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next_</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span> <span class="c1">// callback already called</span>
        <span class="nx">next</span> <span class="o">=</span> <span class="nx">next_</span><span class="p">;</span> <span class="c1">// wait for callback</span>
      <span class="p">});</span>

      <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="c1">// chain promise already called</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span> <span class="c1">// wait for chain to call the promise</span>
      <span class="p">};</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: noError() ? or absorbError()</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="jam-function">JAM function</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Exported function starts the asynchronous call chain.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">jam</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">steps</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h5 id="chain-resolver">Chain resolver.</h5></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The resolver will execute all functions passed to the chain as soon as <code>nextTick</code>.
Thus jam will not works across async context where the chain is not built all at
once in a single event loop, which is not really a problem from my personal
experience.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">tick</span><span class="p">(</span><span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Any errors passed to next() are (fast-)forwarded to the last function in the
chain skipping any functions that's left to be executed.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="k">return</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Any parameters given to next() are passed as arguments to the next function in
the chain (except for errors, of course.)</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">steps</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
        <span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">// error arg</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span> <span class="c1">// next() function</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h5 id="chain-context-continuation">Chain context continuation.</h5></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Subsequent invocation of the function returned from the <code>jam</code> function simply adds
the given function to the chain.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">continuable</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ensureFunc</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// TODO: Handle falsy things?</span>
        <span class="nx">func</span> <span class="o">=</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">steps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">continuable</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">includeHelpers</span><span class="p">(</span><span class="nx">continuable</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">context</span><span class="p">));</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="nx">includeHelpers</span><span class="p">(</span><span class="nx">jam</span><span class="p">);</span>

<span class="p">})();</span></div></div></div></div></body></html>